name: NilStore CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # GO SERVICES (NilChain, Faucet, S3, Relayer)
  # ------------------------------------------------------------------
  go-test:
    name: Go Test (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [nilchain, nil_faucet, nil_gateway, nil_relayer]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # Using modern Go
          cache-dependency-path: ${{ matrix.service }}/go.sum

      - name: Set up Rust
        if: matrix.service == 'nil_gateway' || matrix.service == 'nilchain'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build nil_core
        if: matrix.service == 'nil_gateway' || matrix.service == 'nilchain'
        run: |
          cd nil_core
          cargo build --release

      - name: Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          if [ "${{ matrix.service }}" == "nilchain" ]; then
            echo "Reconstructing vendor for nilchain..."
            go mod vendor
            git checkout vendor
          fi
          
          # Add nil_core release dir to LD_LIBRARY_PATH for nil_gateway/nilchain
          # We use GITHUB_WORKSPACE because working-directory is set to the service dir
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$GITHUB_WORKSPACE/nil_core/target/release
          
          go test ./... -v

  # ------------------------------------------------------------------
  # RUST CRATES (Core, CLI, P2P, Mock L1)
  # ------------------------------------------------------------------
  rust-test:
    name: Rust Test (${{ matrix.crate }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        crate: [nil_core, nil_cli, nil_p2p, nil_mock_l1]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ matrix.crate }}/target
          key: ${{ runner.os }}-cargo-${{ matrix.crate }}-${{ hashFiles(format('{0}/Cargo.lock', matrix.crate)) }}

      - name: Test ${{ matrix.crate }}
        working-directory: ${{ matrix.crate }}
        run: cargo test --verbose

  # ------------------------------------------------------------------
  # FRONTEND (Nil Website)
  # ------------------------------------------------------------------
  frontend-build:
    name: Website Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: nil-website/package-lock.json

      - name: Install Dependencies
        working-directory: nil-website
        run: npm ci

      - name: Type Check & Build
        working-directory: nil-website
        run: npm run build

      - name: Run Unit Tests
        working-directory: nil-website
        run: npm run test:unit

      - name: Lint
        working-directory: nil-website
        run: npm run lint

  e2e-smoke-test:
    name: E2E Smoke Test (Local Stack)
    runs-on: ubuntu-latest
    needs: [go-test, rust-test, frontend-build] # Ensure components are tested individually first
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive # For nil_bridge, etc.

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          target: wasm32-unknown-unknown # Required for wasm-pack build

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM for website
        run: cd nil_core && wasm-pack build --release --target web --out-dir ../nil-website/public/wasm --out-name nil_core

      - name: Build nil_core (native)
        run: cd nil_core && cargo build --release

      - name: Run E2E Lifecycle Script
        run: |
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$GITHUB_WORKSPACE/nil_core/target/release
          scripts/e2e_lifecycle.sh

  # ------------------------------------------------------------------
  # SMART CONTRACTS (Foundry)
  # ------------------------------------------------------------------
  foundry-test:
    name: Solidity Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Tests
        working-directory: nil_bridge
        run: forge test -vv
