syntax = "proto3";
package nilchain.nilchain.v1;

import "gogoproto/gogo.proto";
import "cosmos_proto/cosmos.proto";

option go_package = "nilchain/x/nilchain/types";

// Deal represents a storage deal between a user and the network.
message Deal {
  uint64 id = 1;
  bytes manifest_root = 2; // 48-byte KZG commitment to the Manifest MDU
  uint64 size = 3; // Actual size of current content in bytes (Mutable)
  string owner = 4 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // Address of the deal creator
  string escrow_balance = 5 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // Remaining $STOR for payments
  uint64 start_block = 6; // Block height when deal became active
  uint64 end_block = 7; // Block height when deal expires
  repeated string providers = 8 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // List of assigned SP addresses (Base Layer)
  uint32 redundancy_mode = 9; // e.g., 1 = Standard (RS(12,8))
  uint64 current_replication = 10; // e.g., 12 for base layer, increases with hot replicas
  string service_hint = 11; // "Hot" or "Cold"
  string max_monthly_spend = 12 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // User's monthly spend cap for elasticity
  // Field 13 (deal_size / DealSize) reserved for removed capacity tiers.
  uint64 total_mdus = 14; // Total number of MDUs in the deal
}

// DealHeatState tracks aggregate traffic and performance metrics for a deal.
// Used for "Heat" observability and potential future economic tilting.
message DealHeatState {
  uint64 bytes_served_total = 1;
  uint64 failed_challenges_total = 2;
  int64 last_update_height = 3;
}

// Provider represents a Storage Provider in the network.
message Provider {
  string address = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  uint64 total_storage = 2; // Total storage capacity in bytes
  uint64 used_storage = 3; // Used storage capacity in bytes
  string capabilities = 4; // "Archive", "General", "Edge"
  string status = 5; // "Active", "Offline", "Jailed"
  int64 reputation_score = 6; // Uptime/Performance score
}

// VirtualStripe tracks overlay replicas for a deal, used for elasticity.
message VirtualStripe {
  uint64 deal_id = 1;
  uint32 stripe_index = 2; // Which stripe this refers to (e.g., shard index)
  repeated string overlay_providers = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // List of providers holding this overlay replica
}

// ChainedProof implements the "Triple Proof" architecture for 3-hop verification.
message ChainedProof {
  // Hop 1: Identity (Deal -> MDU)
  uint64 mdu_index = 1;
  bytes mdu_root_fr = 2; // Scalar representation of MDU Merkle Root
  bytes manifest_opening = 3; // KZG proof for Manifest -> MDU Root

  // Hop 2: Structure (MDU -> Blob)
  bytes blob_commitment = 4; // 48-byte KZG commitment of the blob
  repeated bytes merkle_path = 5; // Path from Blob to MDU Root
  uint32 blob_index = 6; // Index of blob in MDU

  // Hop 3: Data (Blob -> Byte)
  bytes z_value = 7;
  bytes y_value = 8;
  bytes kzg_opening_proof = 9;
}

// RetrievalReceipt represents a user's signed confirmation of data retrieval.
message RetrievalReceipt {
  uint64 deal_id = 1;
  uint64 epoch_id = 2;
  string provider = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // Provider's address
  uint64 bytes_served = 4;  // Actual bytes transferred (for one shard chunk)
  ChainedProof proof_details = 5 [(gogoproto.nullable) = false]; // Chained proof for the served chunk
  bytes user_signature = 6; // User's signature over the retrieval fields
  uint64 nonce = 7;         // Strictly increasing per owner/payer to prevent replay
  uint64 expires_at = 8;    // Optional block height/timestamp after which this receipt is invalid (0 = no expiry)
}
