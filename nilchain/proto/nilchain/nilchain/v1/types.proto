syntax = "proto3";
package nilchain.nilchain.v1;

import "gogoproto/gogo.proto";
import "cosmos_proto/cosmos.proto";

option go_package = "nilchain/x/nilchain/types";

// Deal represents a storage deal between a user and the network.
message Deal {
  uint64 id = 1;
  bytes manifest_root = 2; // 48-byte KZG commitment to the Manifest MDU
  uint64 size = 3; // Actual size of current content in bytes (Mutable)
  string owner = 4 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // Address of the deal creator
  string escrow_balance = 5 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // Remaining $STOR for payments
  uint64 start_block = 6; // Block height when deal became active
  uint64 end_block = 7; // Block height when deal expires
  repeated string providers = 8 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // List of assigned SP addresses (Base Layer)
  uint32 redundancy_mode = 9; // e.g., 1 = FullReplica (Mode 1), 2 = StripeReplica (Mode 2: RS(K,K+M), default K=8,M=4)
  uint64 current_replication = 10; // e.g., 12 for base layer, increases with hot replicas
  string service_hint = 11; // "Hot" or "Cold"
  string max_monthly_spend = 12 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // User's monthly spend cap for elasticity
  // Field 13 reserved for removed capacity tiers.
  uint64 total_mdus = 14; // Total number of MDUs in the deal
}

// DealHeatState tracks aggregate traffic and performance metrics for a deal.
// Used for "Heat" observability and potential future economic tilting.
message DealHeatState {
  uint64 bytes_served_total = 1;
  uint64 failed_challenges_total = 2;
  int64 last_update_height = 3;
  uint64 successful_retrievals_total = 4;
}

// Provider represents a Storage Provider in the network.
message Provider {
  string address = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  uint64 total_storage = 2; // Total storage capacity in bytes
  uint64 used_storage = 3; // Used storage capacity in bytes
  string capabilities = 4; // "Archive", "General", "Edge"
  string status = 5; // "Active", "Offline", "Jailed"
  int64 reputation_score = 6; // Uptime/Performance score
  repeated string endpoints = 7; // Provider transport endpoints as Multiaddrs (HTTP now; libp2p future)
}

// VirtualStripe tracks overlay replicas for a deal, used for elasticity.
message VirtualStripe {
  uint64 deal_id = 1;
  uint32 stripe_index = 2; // Which stripe this refers to (e.g., shard index)
  repeated string overlay_providers = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // List of providers holding this overlay replica
}

// ChainedProof implements the "Triple Proof" architecture for 3-hop verification.
message ChainedProof {
  // Hop 1: Identity (Deal -> MDU)
  uint64 mdu_index = 1;
  bytes mdu_root_fr = 2; // Scalar representation of MDU Merkle Root
  bytes manifest_opening = 3; // KZG proof for Manifest -> MDU Root

  // Hop 2: Structure (MDU -> Blob)
  bytes blob_commitment = 4; // 48-byte KZG commitment of the blob
  repeated bytes merkle_path = 5; // Path from Blob to MDU Root
  uint32 blob_index = 6; // Index of blob in MDU

  // Hop 3: Data (Blob -> Byte)
  bytes z_value = 7;
  bytes y_value = 8;
  bytes kzg_opening_proof = 9;
}

// RetrievalSessionStatus is the on-chain lifecycle state for a retrieval session.
enum RetrievalSessionStatus {
  RETRIEVAL_SESSION_STATUS_UNSPECIFIED = 0;
  RETRIEVAL_SESSION_STATUS_OPEN = 1;
  RETRIEVAL_SESSION_STATUS_PROOF_SUBMITTED = 2;
  RETRIEVAL_SESSION_STATUS_USER_CONFIRMED = 3;
  RETRIEVAL_SESSION_STATUS_COMPLETED = 4;
  RETRIEVAL_SESSION_STATUS_EXPIRED = 5;
  RETRIEVAL_SESSION_STATUS_CANCELED = 6;
}

// RetrievalSession is an on-chain authorization + completion object for a blob-range retrieval.
// It is provider-bound, deal-bound, and pins the current Deal.manifest_root to avoid ambiguity.
message RetrievalSession {
  bytes session_id = 1; // 32-byte keccak256 hash of canonical session fields
  uint64 deal_id = 2;
  string owner = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  string provider = 4 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  bytes manifest_root = 5; // 48-byte KZG commitment pinned at session open

  uint64 start_mdu_index = 6;
  uint32 start_blob_index = 7;
  uint64 blob_count = 8;
  uint64 total_bytes = 9; // blob_count * 131072

  uint64 nonce = 10; // strictly increasing per (owner, deal_id, provider)
  uint64 expires_at = 11; // block height (0 = no expiry)

  int64 opened_height = 12;
  int64 updated_height = 13;
  RetrievalSessionStatus status = 14;

  string locked_fee = 15 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // Locked variable fee (excludes base fee)
}

// RetrievalReceipt represents a user's signed confirmation of data retrieval.
message RetrievalReceipt {
  uint64 deal_id = 1;
  uint64 epoch_id = 2;
  string provider = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // Provider's address
  uint64 bytes_served = 4;  // Actual bytes transferred (for one shard chunk)
  ChainedProof proof_details = 5 [(gogoproto.nullable) = false]; // Chained proof for the served chunk
  bytes user_signature = 6; // User's signature over the retrieval fields
  uint64 nonce = 7;         // Strictly increasing per (deal_id, file_path) to prevent replay
  uint64 expires_at = 8;    // Optional block height/timestamp after which this receipt is invalid (0 = no expiry)
  string file_path = 9;     // NilFS file path (opaque to chain; used for nonce scoping and audits)
  uint64 range_start = 10;  // Byte range start within file (for auditability/accounting)
  uint64 range_len = 11;    // Byte range length within file (MUST equal bytes_served)
}

// RetrievalReceiptBatch allows a provider to submit multiple receipts in one tx.
message RetrievalReceiptBatch {
  repeated RetrievalReceipt receipts = 1 [(gogoproto.nullable) = false];
}

// DownloadSessionReceipt is a session-level user signature authorizing a set of chunk proofs.
// The session commits to a Merkle root over per-chunk leaf hashes derived from (range_start, range_len, proof_hash).
message DownloadSessionReceipt {
  uint64 deal_id = 1;
  uint64 epoch_id = 2;
  string provider = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  string file_path = 4;
  uint64 total_bytes = 5;
  uint64 chunk_count = 6;
  bytes chunk_leaf_root = 7; // 32-byte Merkle root over chunk leaf hashes
  bytes user_signature = 8;  // 65-byte EIP-712 signature (R||S||V)
  uint64 nonce = 9;          // Strictly increasing per (deal_id, file_path)
  uint64 expires_at = 10;    // Optional expiry (0 = no expiry)
}

// SessionChunkProof is a single proved chunk within a DownloadSessionReceipt.
message SessionChunkProof {
  uint64 range_start = 1;
  uint64 range_len = 2;
  ChainedProof proof_details = 3 [(gogoproto.nullable) = false];
  uint32 leaf_index = 4;          // Index of leaf in the session Merkle tree
  repeated bytes merkle_path = 5; // Merkle path siblings (32-byte nodes)
}

// RetrievalSessionProof bundles a session receipt with the per-chunk proofs it commits to.
message RetrievalSessionProof {
  DownloadSessionReceipt session_receipt = 1 [(gogoproto.nullable) = false];
  repeated SessionChunkProof chunks = 2 [(gogoproto.nullable) = false];
}
