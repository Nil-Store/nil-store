syntax = "proto3";
package nilchain.nilchain.v1;

import "amino/amino.proto";
import "cosmos/msg/v1/msg.proto";
import "cosmos_proto/cosmos.proto";
import "gogoproto/gogo.proto";
import "nilchain/nilchain/v1/params.proto";
import "nilchain/nilchain/v1/types.proto"; // NEW: Import types.proto

option go_package = "nilchain/x/nilchain/types";

// Msg defines the Msg service.
service Msg {
  option (cosmos.msg.v1.service) = true;

  // UpdateParams defines a (governance) operation for updating the module
  // parameters. The authority defaults to the x/gov module account.
  rpc UpdateParams(MsgUpdateParams) returns (MsgUpdateParamsResponse);

  // MsgRegisterProvider allows a Storage Provider to register themselves with the network.
  rpc RegisterProvider(MsgRegisterProvider) returns (MsgRegisterProviderResponse);

  // MsgCreateDeal allows a user to create a new storage deal.
  rpc CreateDeal(MsgCreateDeal) returns (MsgCreateDealResponse);

  // MsgCreateDealFromEvm allows a user to create a new storage deal
  // using an EVM-signed intent bridged into nilchaind.
  rpc CreateDealFromEvm(MsgCreateDealFromEvm) returns (MsgCreateDealFromEvmResponse);

  // MsgProveLiveness allows a Storage Provider to submit a proof of data liveness.
  rpc ProveLiveness(MsgProveLiveness) returns (MsgProveLivenessResponse);

  // MsgSignalSaturation allows a Storage Provider to signal high load for a deal.
  rpc SignalSaturation(MsgSignalSaturation) returns (MsgSignalSaturationResponse);

  // MsgAddCredit allows a user to top up the escrow balance for a deal.
  rpc AddCredit(MsgAddCredit) returns (MsgAddCreditResponse);

  // MsgWithdrawRewards allows a Storage Provider to withdraw accumulated rewards.
  rpc WithdrawRewards(MsgWithdrawRewards) returns (MsgWithdrawRewardsResponse);
}

// MsgUpdateParams is the Msg/UpdateParams request type.
message MsgUpdateParams {
  option (cosmos.msg.v1.signer) = "authority";
  option (amino.name) = "nilchain/x/nilchain/MsgUpdateParams";

  // authority is the address that controls the module (defaults to x/gov unless overwritten).
  string authority = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // params defines the module parameters to update.
  //
  // NOTE: All parameters must be supplied.
  Params params = 2 [
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// MsgUpdateParamsResponse defines the response structure for executing a
// MsgUpdateParams message.
message MsgUpdateParamsResponse {}

// MsgRegisterProvider allows a Storage Provider to register themselves with the network.
message MsgRegisterProvider {
  option (cosmos.msg.v1.signer) = "creator";
  option (amino.name) = "nilchain/x/nilchain/MsgRegisterProvider";

  string creator = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  string capabilities = 2; // "Archive", "General", "Edge"
  uint64 total_storage = 3; // Total storage capacity in bytes
}

// MsgRegisterProviderResponse defines the response structure for registering a provider.
message MsgRegisterProviderResponse {
  bool success = 1;
}

// MsgCreateDeal allows a user to create a new storage deal.
message MsgCreateDeal {
  option (cosmos.msg.v1.signer) = "creator";
  option (amino.name) = "nilchain/x/nilchain/MsgCreateDeal";

  string creator = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  string cid = 2; // Root CID of the file manifest
  uint64 size = 3; // Total size in bytes
  uint64 duration_blocks = 4; // Duration of the deal in blocks
  string service_hint = 5; // "Hot" or "Cold"
  string max_monthly_spend = 6 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // User's monthly spend cap for elasticity
  string initial_escrow_amount = 7 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false]; // Initial $STOR amount
}

// MsgCreateDealResponse defines the response structure for creating a deal.
message MsgCreateDealResponse {
  uint64 deal_id = 1;
  repeated string assigned_providers = 2 [(cosmos_proto.scalar) = "cosmos.AddressString"];
}

// EvmCreateDealIntent captures the fields that an EVM wallet signs over
// when creating a storage deal via the bridge path.
message EvmCreateDealIntent {
  string creator_evm = 1;       // 0x-prefixed EVM address
  string cid = 2;               // Root CID
  uint64 size_bytes = 3;        // Total size in bytes
  uint64 duration_blocks = 4;   // Duration of the deal in blocks
  string service_hint = 5;      // Service hint (e.g. General:replicas=N)
  string initial_escrow = 6 [
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false
  ]; // Initial escrow amount (stake)
  string max_monthly_spend = 7 [
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false
  ]; // Monthly spend cap (stake)
  uint64 nonce = 8;             // Per-EVM-address bridge nonce (strictly increasing)
  string chain_id = 9;          // nilchaind chain-id (e.g. "test-1")
}

// MsgCreateDealFromEvm wraps a signed EVM intent and is executed on nilchaind.
message MsgCreateDealFromEvm {
  option (cosmos.msg.v1.signer) = "sender";
  option (amino.name) = "nilchain/x/nilchain/MsgCreateDealFromEvm";

  // sender is the Cosmos address paying gas (relayer or user).
  string sender = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  // intent is the structured deal payload signed by the EVM account.
  EvmCreateDealIntent intent = 2;
  // evm_signature is a 65-byte ECDSA signature (R||S||V) over the intent payload.
  bytes evm_signature = 3;
}

// MsgCreateDealFromEvmResponse returns the newly created deal ID.
message MsgCreateDealFromEvmResponse {
  uint64 deal_id = 1;
}

// MsgProveLiveness allows a Storage Provider to submit a proof of data liveness.
message MsgProveLiveness {
  option (cosmos.msg.v1.signer) = "creator";
  option (amino.name) = "nilchain/x/nilchain/MsgProveLiveness";

  string creator = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  uint64 deal_id = 2;
  uint64 epoch_id = 3;

  oneof proof_type {
    RetrievalReceipt user_receipt = 4; // Path A (Hot)
    KzgProof system_proof = 5;         // Path B (Cold)
  }
}

// MsgProveLivenessResponse defines the response structure for proving liveness.
message MsgProveLivenessResponse {
  bool success = 1;
  uint32 tier = 2; // e.g., Platinum, Gold, Silver, Fail (mapped to 0,1,2,3)
  string reward_amount = 3; // Actual reward amount
}

// MsgSignalSaturation allows a Storage Provider to signal high load for a deal.
message MsgSignalSaturation {
  option (cosmos.msg.v1.signer) = "creator";
  option (amino.name) = "nilchain/x/nilchain/MsgSignalSaturation";

  string creator = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  uint64 deal_id = 2;
}

// MsgSignalSaturationResponse defines the response structure for signaling saturation.
message MsgSignalSaturationResponse {
  bool success = 1;
  string message = 2;
  repeated string new_providers = 3 [(cosmos_proto.scalar) = "cosmos.AddressString"]; // Newly spawned hot replica providers
}

// MsgAddCredit allows a user to top up the escrow balance for a deal.
message MsgAddCredit {
  option (cosmos.msg.v1.signer) = "creator";
  option (amino.name) = "nilchain/x/nilchain/MsgAddCredit";

  string creator = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
  uint64 deal_id = 2;
  string amount = 3 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false];
}

// MsgAddCreditResponse defines the response structure for adding credit.
message MsgAddCreditResponse {
  string new_balance = 1 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false];
}

// MsgWithdrawRewards allows a Storage Provider to withdraw accumulated rewards.
message MsgWithdrawRewards {
  option (cosmos.msg.v1.signer) = "creator";
  option (amino.name) = "nilchain/x/nilchain/MsgWithdrawRewards";

  string creator = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];
}

// MsgWithdrawRewardsResponse defines the response structure for withdrawing rewards.
message MsgWithdrawRewardsResponse {
  string amount_withdrawn = 1 [(gogoproto.customtype) = "cosmossdk.io/math.Int", (gogoproto.nullable) = false];
}
